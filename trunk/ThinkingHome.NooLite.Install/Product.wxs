<?xml version="1.0" encoding="UTF-8"?>
<Wix
	xmlns="http://schemas.microsoft.com/wix/2006/wi"
	xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
	xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension" >

	<?include Variables.wxi?>


	<Product Id="$(var.ProductCode)" Name="$(var.ProductName)" Language="1049" Version="$(var.ProductVersion)" Manufacturer="$(var.Manufacturer)" UpgradeCode="$(var.UpgradeCode)">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
		<Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

		<MajorUpgrade DowngradeErrorMessage="A newer version of $(var.ProductName) is already installed." />

		<Binary  Id="CustomActionsDll" SourceFile="..\ThinkingHome.NooLite.Install.CustomActions\bin\Debug\ThinkingHome.NooLite.Install.CustomActions.CA.dll" />

		<Feature Id="ProductFeature" Title="$(var.ProductName)" Level="1">
			<ComponentGroupRef Id="ProductComponents" />
			<ComponentGroupRef Id="ProductShortcuts" />
		</Feature>

		<PropertyRef Id="NETFRAMEWORK40FULL"/>
		<Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
		<Property Id="WEBSITE_PORT"  Value="8080" />

		<UIRef Id="WixUI_InstallDirNoolite" />

		<Condition Message="This application requires .NET Framework 4.0. Please install the .NET Framework then run this installer again.">
			<![CDATA[Installed OR NETFRAMEWORK40FULL]]>
		</Condition>
	</Product>



	<Fragment>

		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="DesktopFolder">
			</Directory>
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLFOLDER" Name="$(var.ProductName)" />
			</Directory>
		</Directory>

		<CustomAction Id="SetAppId" Property="APP_ID" Value="$(var.UpgradeCode)" Execute="immediate" />
		<CustomAction Id="SetPort" Property="APP_PORT" Value="[WEBSITE_PORT]" Execute="immediate" />
		<CustomAction Id="SetPath" Property="APP_PATH" Value="[WEBAPPFOLDER]" Execute="immediate" />
		<CustomAction Id="RegisterWebApp" Execute="immediate" Return="check" BinaryKey="CustomActionsDll" DllEntry="RegisterApplication" />
		<CustomAction Id="UnRegisterWebApp" Execute="immediate" Return="check" BinaryKey="CustomActionsDll" DllEntry="UnRegisterApplication" />

		<InstallExecuteSequence>
			<Custom Action='SetAppId' After='InstallFiles' />
			<Custom Action='SetPort' After='SetAppId' />
			<Custom Action='SetPath' After='SetPort' />
			<Custom Action='RegisterWebApp' After="SetPath">NOT Installed</Custom>
			<Custom Action='UnRegisterWebApp' After="SetPath">Installed</Custom>
		</InstallExecuteSequence>

	</Fragment>

	<Fragment>

		<ComponentGroup Id="ProductShortcuts">
			<Component
				Id="ProductShortcut"
				Guid="D7EE113C-2F21-4526-B432-4B51563807F4"
				DiskId="1"
				Directory="DesktopFolder">
				<Shortcut Id="ConfiguratorDesktopShortcut"
					Name="nooLite Web Configurator"
					Description="$(var.ProductName) Configurator"
					Target="[WEBAPPFOLDER]Configurator.exe"
					WorkingDirectory="WEBAPPFOLDER"/>
				<util:InternetShortcut Id="WebAppDesktopShortcut"
					Name="$(var.ProductName)"
					Target="http://localhost:[WEBSITE_PORT]"/>
				<RemoveFolder Id="DesktopFolder" On="uninstall"/>
				<RegistryValue
					Root="HKCU"
					Key="Software/NooLite Web Control Panel"
					Name="installed"
					Type="integer"
					Value="1"
					KeyPath="yes"/>
			</Component>
		</ComponentGroup>

	</Fragment>


</Wix>